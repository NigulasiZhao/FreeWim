<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºèƒ½ä»»åŠ¡è°ƒåº¦</title>

    <script src="/lib/tailwindcss/tailwindcss.com.js"></script>

    <link rel="stylesheet" href="/lib/jsdelivr/flatpickr.min.css">
    <script src="/lib/jsdelivr/flatpickr.min.js"></script>
    <script src="/lib/jsdelivr/zh.js"></script>
    <link rel="stylesheet" href="/lib/jsdelivr/all.min.css">

    <style>
        /* ... åŸºç¡€æ ·å¼ä¿æŒä¸å˜ ... */
        body {
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }

        .flatpickr-calendar {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
            border: none !important;
            border-radius: 1rem !important;
            padding: 10px !important;
        }

        .flatpickr-day.selected {
            background: #2563eb !important;
            border-color: #2563eb !important;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* ã€å…³é”®ã€‘è®¾ç½®åˆ—è¡¨å®¹å™¨çš„æœ€å¤§é«˜åº¦å’Œæ»šåŠ¨æ¡ */
        #task-list-wrapper {
            max-height: 50vh; /* åˆ—è¡¨ä¸­é—´å®¹å™¨é«˜åº¦é™åˆ¶åœ¨è§†å£é«˜åº¦çš„50% */
            overflow-y: scroll;
            border-radius: 0.5rem;
            padding-right: 5px; /* ç•™å‡ºä¸€ç‚¹ç©ºé—´ç»™æ»šåŠ¨æ¡ï¼Œç¾è§‚ */
        }

        /* ä¿®å¤ Flatpickr åœ¨æ·±è‰²æ¨¡å¼ä¸‹çš„æ˜¾ç¤ºé—®é¢˜ */
        .flatpickr-calendar {
            background-color: #ffffff !important;
            color: #374151 !important;
        }
        .flatpickr-month, .flatpickr-prev-month, .flatpickr-next-month, .flatpickr-current-month .cur-month, .flatpickr-current-month .cur-year {
            color: #374151 !important;
            fill: #374151 !important;
        }
        .flatpickr-day {
            color: #374151 !important;
        }
        .flatpickr-day.selected {
            color: #ffffff !important;
            background-color: #2563eb !important;
            border-color: #2563eb !important;
        }
        .flatpickr-time input {
            color: #374151 !important;
        }
        .flatpickr-time .flatpickr-time-separator, .flatpickr-time .flatpickr-am-pm {
            color: #374151 !important;
        }

        /* æ·±è‰²æ¨¡å¼é€‚é… */
        @media (prefers-color-scheme: dark) {
            .flatpickr-calendar {
                background-color: #1f2937 !important; /* gray-800 */
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5) !important;
            }
            .flatpickr-month, .flatpickr-prev-month, .flatpickr-next-month, .flatpickr-current-month .cur-month, .flatpickr-current-month .cur-year {
                color: #e5e7eb !important; /* gray-200 */
                fill: #e5e7eb !important;
            }
            .flatpickr-day {
                color: #e5e7eb !important;
            }
            .flatpickr-day.flatpickr-disabled, .flatpickr-day.flatpickr-disabled:hover {
                color: #4b5563 !important; /* gray-600 */
            }
            .flatpickr-day:hover, .flatpickr-day:focus {
                background-color: #374151 !important; /* gray-700 */
            }
            .flatpickr-day.selected {
                background-color: #2563eb !important;
                color: #ffffff !important;
            }
            .flatpickr-time input {
                color: #e5e7eb !important;
            }
            .flatpickr-time .flatpickr-time-separator, .flatpickr-time .flatpickr-am-pm {
                color: #e5e7eb !important;
            }
        }
    </style>
</head>
<body class="text-gray-800 font-sans antialiased min-h-screen flex flex-col items-center py-6 sm:py-10 px-4">

<div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl overflow-hidden relative">

    <div class="bg-gradient-to-r from-blue-600 to-blue-500 px-6 py-8 text-white">
        <h1 class="text-2xl font-bold flex items-center gap-3">
            <i class="fa-solid fa-rocket"></i>
            ä»»åŠ¡è°ƒåº¦ä¸­å¿ƒ
        </h1>
    </div>

    <div class="p-6">
        <div class="mb-2">
            <label class="block text-sm font-bold text-gray-700 mb-2 ml-1">æ‰§è¡Œæ—¶é—´</label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-blue-500"><i
                        class="fa-regular fa-calendar-alt text-lg"></i></div>
                <input type="datetime-local" id="datetime-picker"
                       class="w-full pl-12 pr-4 py-4 bg-gray-50 hover:bg-white border-2 border-gray-100 hover:border-blue-300 focus:border-blue-500 rounded-xl transition-all outline-none text-lg text-gray-800 font-medium cursor-pointer shadow-sm appearance-none"
                       placeholder="è¯·é€‰æ‹©æ—¶é—´...">
                <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-gray-400"><i
                        class="fa-solid fa-chevron-down text-xs"></i></div>
            </div>
        </div>
        <div class="mb-8 flex gap-2 overflow-x-auto no-scrollbar pb-1">
            <button onclick="setToNight()"
                    class="whitespace-nowrap px-4 py-2 bg-gray-100 text-gray-600 rounded-full text-sm font-medium hover:bg-gray-200 transition border border-gray-200 active:scale-95">
                ğŸŒ™ ä»Šæ™š19ç‚¹30
            </button>
            <button onclick="setTomorrowMorning()"
                    class="whitespace-nowrap px-4 py-2 bg-gray-100 text-gray-600 rounded-full text-sm font-medium hover:bg-gray-200 transition border border-gray-200 active:scale-95">
                â˜€ï¸ æ˜æ—©8ç‚¹
            </button>
        </div>
        <button onclick="submitTime()" id="submit-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-bold py-4 rounded-xl shadow-lg shadow-blue-200 transition-all transform active:scale-[0.98] flex justify-center items-center gap-2 text-lg">
            <span>æäº¤è®¡åˆ’</span>
        </button>
    </div>

    <div class="bg-gray-50 border-t border-gray-200 p-6">
        <div class="flex justify-between items-end mb-5">
            <h2 class="text-lg font-bold text-gray-800">æ‰§è¡Œè®°å½•</h2>
            <button onclick="refreshList()"
                    class="text-sm bg-white border border-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-50 shadow-sm">
                <i class="fa-solid fa-sync" id="refresh-icon"></i>
            </button>
        </div>

        <div id="task-list-wrapper" class="no-scrollbar">
            <div id="task-list" class="space-y-3">
            </div>
        </div>

        <div id="list-status" class="text-center py-4 text-gray-400">
        </div>
    </div>
</div>

<script>
    let fpInstance;
    const taskListWrapper = document.getElementById('task-list-wrapper');
    const taskList = document.getElementById('task-list');
    const listStatus = document.getElementById('list-status');

    // ============================================================
    // 1. API é…ç½®ä¸åˆ†é¡µçŠ¶æ€
    // ============================================================
    const API = {
        GET_LIST: '/api/AttendanceRecord/GetAutoCheckInList',
        POST_SUBMIT: '/api/AttendanceRecord/AutoCheckIn',
        POST_CANCEL: '/api/AttendanceRecord/CancelAutoCheckIn'
    };

    // åˆ†é¡µçŠ¶æ€ç®¡ç†
    let currentPage = 1;
    const rowsPerPage = 10;
    let isLoading = false;
    let hasMoreData = true;

    // ============================================================
    // 2. çŠ¶æ€æ˜ å°„å·¥å…· (ä¿æŒä¸å˜)
    // ============================================================
    function getStatusProps(state) {
        switch (state) {
            case 1:
                return {text: 'æˆåŠŸ', icon: 'fa-check', color: 'green', canCancel: false};
            case 2:
                return {text: 'å¤±è´¥', icon: 'fa-times', color: 'red', canCancel: false};
            case 0:
            default:
                return {text: 'æ‰§è¡Œä¸­', icon: 'fa-clock', color: 'blue', canCancel: true};
        }
    }

    // ============================================================
    // 3. æ ¸å¿ƒ API ç»‘å®šå‡½æ•°
    // ============================================================

    /**
     * åŠ è½½ä¸‹ä¸€é¡µæ•°æ®
     */
    async function loadNextPage(reset = false) {
        if (isLoading || (reset === false && hasMoreData === false)) {
            return;
        }

        if (reset) {
            // é‡ç½®çŠ¶æ€
            currentPage = 1;
            hasMoreData = true;
            taskList.innerHTML = '';
            listStatus.innerHTML = '';
        }

        isLoading = true;
        listStatus.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> æ­£åœ¨åŠ è½½...';

        try {
            // æ„å»ºå¸¦åˆ†é¡µå‚æ•°çš„ URL
            const url = `${API.GET_LIST}?Page=${currentPage}&Rows=${rowsPerPage}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');

            const data = await response.json();
            // å‡è®¾ API è¿”å›çš„æ˜¯åˆ—è¡¨æ•°ç»„
            const records = data || [];

            if (records.length > 0) {
                records.forEach(item => {
                    renderRecord(item);
                });
                currentPage++; // é¡µç é€’å¢
            }

            // åˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
            if (records.length < rowsPerPage) {
                hasMoreData = false;
                listStatus.innerHTML = (currentPage === 1 && records.length === 0)
                    ? '<i class="fa-regular fa-folder-open"></i> æš‚æ— ä»»åŠ¡è®°å½•'
                    : 'â€”â€” å·²åŠ è½½å…¨éƒ¨æ•°æ® â€”â€”';
            } else {
                listStatus.innerHTML = ''; // æ¸…é™¤ loading çŠ¶æ€
            }

        } catch (error) {
            console.error("åŠ è½½åˆ—è¡¨å¤±è´¥:", error);
            listStatus.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-red-500"></i> åŠ è½½å¤±è´¥`;
        } finally {
            isLoading = false;
        }
    }

    // æäº¤æˆåŠŸåè°ƒç”¨æ­¤å‡½æ•°
    function refreshList() {
        loadNextPage(true); // é‡ç½®å¹¶åŠ è½½ç¬¬ä¸€é¡µ
    }

    async function submitTime() {
        let selectedDateStr = "";
        if (fpInstance.selectedDates.length > 0) {
            const dateObj = fpInstance.selectedDates[0];
            const pad = (n) => (n < 10 ? '0' : '') + n;
            selectedDateStr = dateObj.getFullYear() + '-' + pad(dateObj.getMonth() + 1) + '-' + pad(dateObj.getDate()) +
                'T' + pad(dateObj.getHours()) + ':' + pad(dateObj.getMinutes()) + ':' + pad(dateObj.getSeconds());
        }

        if (!selectedDateStr) {
            alert("è¯·é€‰æ‹©æœ‰æ•ˆçš„æ—¶é—´");
            return;
        }

        const btn = document.getElementById('submit-btn');
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> å¤„ç†ä¸­...';
        btn.classList.add('opacity-75', 'cursor-not-allowed');

        try {
            const response = await fetch(API.POST_SUBMIT, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({selectTime: selectedDateStr})
            });

            if (!response.ok) throw new Error('æäº¤å¤±è´¥');

            const data = await response.json();
            if (data && data.message.includes("æˆåŠŸ")) {
                alert("æäº¤æˆåŠŸï¼ä»»åŠ¡å·²åˆ›å»ºã€‚");
                refreshList();
            } else {
                alert("æäº¤å¤±è´¥ï¼š" + data.message);
            }

        } catch (error) {
            console.error("æäº¤å¤±è´¥:", error);
            alert("æäº¤å¤±è´¥ï¼š" + error.message);
        } finally {
            btn.innerHTML = '<span>æäº¤è®¡åˆ’</span>';
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    }

    async function cancelTask(btnElement, jobId) {
        if (!confirm(`ç¡®å®šè¦å–æ¶ˆ Job ID: ${jobId} çš„ä»»åŠ¡å—ï¼Ÿ`)) {
            return;
        }

        const originalText = btnElement.innerText;
        btnElement.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i>';
        btnElement.disabled = true;

        try {
            const response = await fetch(API.POST_CANCEL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({jobId: jobId})
            });

            if (!response.ok) throw new Error('å–æ¶ˆå¤±è´¥');

            alert(`ä»»åŠ¡ Job ID: ${jobId} å·²å–æ¶ˆï¼`);

            refreshList(); // å–æ¶ˆæˆåŠŸååˆ·æ–°åˆ—è¡¨

        } catch (error) {
            console.error("å–æ¶ˆå¤±è´¥:", error);
            alert("å–æ¶ˆå¤±è´¥ï¼š" + error.message);
        }
    }

    // ------------------------------------------------------------
    // 4. æ»šåŠ¨æ£€æµ‹ä¸ Debounce
    // ------------------------------------------------------------

    // ç®€å•çš„ Debounce å‡½æ•°ï¼Œé˜²æ­¢æ»šåŠ¨äº‹ä»¶è§¦å‘è¿‡äºé¢‘ç¹
    function debounce(func, delay) {
        let timeout;
        return function () {
            const context = this;
            const args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    function checkScroll() {
        // æ»šåŠ¨æ¡è·ç¦»åº•éƒ¨çš„è·ç¦»
        const scrollDistance = taskListWrapper.scrollHeight - taskListWrapper.scrollTop - taskListWrapper.clientHeight;

        // å½“è·ç¦»åº•éƒ¨å°äº 50px ä¸”å½“å‰ä¸åœ¨åŠ è½½ä¸­ ä¸” è¿˜æœ‰æ›´å¤šæ•°æ®æ—¶ï¼ŒåŠ è½½ä¸‹ä¸€é¡µ
        if (scrollDistance < 50 && !isLoading && hasMoreData) {
            loadNextPage();
        }
    }

    // ------------------------------------------------------------
    // 5. æ¸²æŸ“å‡½æ•° (ä¿æŒç»“æ„ä¸å˜ï¼Œä»…æ·»åŠ JobIdåˆ°åˆ—è¡¨é¡¹)
    // ------------------------------------------------------------

    function renderRecord(item) {
        const props = getStatusProps(item.clockinstate);
        const dateObj = new Date(item.clockintime);
        const timeDisplay = dateObj.toLocaleTimeString('zh-CN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const dateDisplay = dateObj.toLocaleDateString('zh-CN', {year: 'numeric', month: '2-digit', day: '2-digit'});

        const cancelButtonHTML = props.canCancel ? `
                <button onclick="cancelTask(this, '${item.jobid}')" 
                        class="px-3 py-1.5 rounded-lg bg-white border border-red-200 text-red-500 text-xs font-medium hover:bg-red-50 hover:text-red-600 transition shadow-sm active:scale-95 whitespace-nowrap">
                    å–æ¶ˆ
                </button>` : '';

        const div = document.createElement('div');
        div.className = `group bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex items-center justify-between hover:shadow-md transition cursor-default`;

        div.innerHTML = `
                <div class="flex items-center gap-3 w-3/5">
                    <div class="w-10 h-10 rounded-full bg-${props.color}-50 text-${props.color}-500 flex items-center justify-center text-lg flex-shrink-0">
                        <i class="fa-solid ${props.icon}"></i>
                    </div>
                    <div class="overflow-hidden">
                        <div class="font-bold text-gray-800 text-sm sm:text-base truncate">${timeDisplay}</div>
                        <div class="text-xs text-gray-400">${dateDisplay} (Job ID: ${item.jobid})</div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2 flex-shrink-0">
                    <span class="px-2 py-1 rounded-md text-xs font-bold bg-${props.color}-50 text-${props.color}-600 border border-${props.color}-100 hidden sm:inline-block">
                        ${props.text}
                    </span>
                    ${cancelButtonHTML}
                </div>
            `;

        taskList.appendChild(div);
    }

    // ============================================================
    // 6. åˆå§‹åŒ–
    // ============================================================

    document.addEventListener('DOMContentLoaded', () => {
        // Flatpickr åˆå§‹åŒ–
        fpInstance = flatpickr("#datetime-picker", {
            enableTime: true,
            dateFormat: "Y-m-d H:i:s",
            time_24hr: true,
            defaultDate: new Date().setMinutes(new Date().getMinutes() + 5),
            locale: "zh",
            disableMobile: true,
            allowInput: true
        });

        // ç»‘å®šæ»šåŠ¨äº‹ä»¶ï¼Œå¹¶ä½¿ç”¨ debounce ä¼˜åŒ–æ€§èƒ½
        taskListWrapper.addEventListener('scroll', debounce(checkScroll, 100));

        // é¡µé¢åŠ è½½æ—¶ç«‹å³åŠ è½½ç¬¬ä¸€é¡µæ•°æ®
        loadNextPage(true);
    });

    function setToNight() {
        const date = new Date();
        date.setHours(19, 30, 0, 0);
        fpInstance.setDate(date);
    }

    function setTomorrowMorning() {
        const date = new Date();
        date.setDate(date.getDate() + 1);
        date.setHours(8, 0, 0, 0);
        fpInstance.setDate(date);
    }
</script>
</body>
</html>