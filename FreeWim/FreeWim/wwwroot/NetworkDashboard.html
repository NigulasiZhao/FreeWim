<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络质量看板</title>
    <!-- 使用本地静态资源加速加载 -->
    <script src="/tailwindcss.js"></script>
    <script src="/echarts.min.js"></script>
    <script src="/phosphor-icons.min.js"></script>
    
    <style>
        /* 1. 全局背景：柔和的蓝紫极光渐变 */
        body {
            background: #f3f4f6;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,90%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,85%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,85%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: #334155; /* Slate-700 */
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, sans-serif;
        }

        /* 2. iOS 白透毛玻璃风格 */
        .glass-card {
            background: rgba(255, 255, 255, 0.65); /* 白色半透明 */
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 20px 0 rgba(0, 0, 0, 0.05); /* 极轻柔的阴影 */
            border-radius: 20px;
            transition: all 0.2s ease;
        }
        
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
        }

        /* 3. 输入框自定义样式 */
        .glass-input {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(203, 213, 225, 0.6);
            border-radius: 10px;
            padding: 6px 12px;
            font-size: 0.875rem;
            color: #475569;
            outline: none;
            transition: all 0.2s;
        }
        .glass-input:focus {
            background: white;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* 滚动条美化 */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-6">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 px-1">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-slate-800">网络监控看板</h1>
                <p class="text-slate-500 text-sm mt-1">家庭宽带质量追踪</p>
            </div>
            
            <div class="glass-card px-4 py-3 flex flex-wrap items-center gap-3 shadow-sm">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold text-slate-400 uppercase"></span>
                    <input type="date" id="start-date" class="glass-input">
                    <span class="text-slate-400">-</span>
                    <input type="date" id="end-date" class="glass-input">
                </div>
                <div class="w-px h-6 bg-slate-300 mx-1"></div>
                <div class="flex gap-2">
                    <button id="btn-7days" onclick="setRange(7)" class="px-3 py-1.5 text-xs font-medium bg-white hover:bg-slate-50 border border-slate-200 rounded-lg text-slate-600 transition-colors">近7天</button>
                    <button id="btn-30days" onclick="setRange(30)" class="px-3 py-1.5 text-xs font-medium bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg text-blue-600 transition-colors">近30天</button>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
            <div class="glass-card p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">平均下载速度</p>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span class="text-3xl font-bold text-slate-800" id="stat-dl">--</span>
                            <span class="text-sm text-slate-500">Mbps</span>
                        </div>
                    </div>
                    <div class="p-2 bg-blue-50 rounded-lg text-blue-500">
                        <i class="ph ph-download-simple text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">平均上传速度</p>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span class="text-3xl font-bold text-slate-800" id="stat-ul">--</span>
                            <span class="text-sm text-slate-500">Mbps</span>
                        </div>
                    </div>
                    <div class="p-2 bg-purple-50 rounded-lg text-purple-500">
                        <i class="ph ph-upload-simple text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">平均 Ping 值</p>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span class="text-3xl font-bold text-emerald-600" id="stat-ping">--</span>
                            <span class="text-sm text-slate-500">ms</span>
                        </div>
                    </div>
                    <div class="p-2 bg-emerald-50 rounded-lg text-emerald-500">
                        <i class="ph ph-lightning text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="glass-card p-6">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-500 text-sm font-medium">记录条数</p>
                        <div class="mt-2 flex items-baseline gap-2">
                            <span class="text-3xl font-bold text-slate-800" id="stat-count">--</span>
                            <span class="text-sm text-slate-500">次</span>
                        </div>
                    </div>
                    <div class="p-2 bg-orange-50 rounded-lg text-orange-500">
                        <i class="ph ph-database text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-card p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-700">速度趋势分析</h3>
                <div class="flex gap-4 text-xs">
                    <span class="flex items-center gap-1.5 text-slate-500"><span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span>下载</span>
                    <span class="flex items-center gap-1.5 text-slate-500"><span class="w-2.5 h-2.5 rounded-full bg-purple-500"></span>上传</span>
                </div>
            </div>
            <div id="mainChart" class="w-full h-[400px]"></div>
        </div>

        <div class="glass-card p-6">
            <h3 class="text-lg font-bold text-slate-700 mb-4">详细记录</h3>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="text-xs text-slate-400 uppercase border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3 font-medium">时间</th>
                            <th class="px-4 py-3 font-medium">服务器</th>
                            <th class="px-4 py-3 font-medium text-right">下载 (Mbps)</th>
                            <th class="px-4 py-3 font-medium text-right">上传 (Mbps)</th>
                            <th class="px-4 py-3 font-medium text-right">Ping</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. 从后台接口获取数据
        // ==========================================
        let fullData = [];

        async function fetchData(startDate, endDate) {
            try {
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                
                const response = await fetch(`/api/SpeedTest/GetRecordsByDateRange?${params.toString()}`);
                const result = await response.json();
                
                if (result.message === 'ok' && result.data) {
                    // 转换数据格式以匹配前端需求
                    fullData = result.data.map(item => ({
                        id: item.id,
                        created_at: item.created_at ? item.created_at.split('T')[0] : '',
                        download: parseFloat(item.download) || 0,
                        upload: parseFloat(item.upload) || 0,
                        ping: parseFloat(item.ping) || 0,
                        server_name: item.server_name || 'Unknown'
                    }));
                    console.log(`加载了 ${fullData.length} 条数据`);
                } else {
                    console.error('获取数据失败:', result);
                    fullData = [];
                }
            } catch (error) {
                console.error('请求失败:', error);
                fullData = [];
            }
        }

        // ==========================================
        // 2. 核心逻辑：筛选与渲染
        // ==========================================
        const chartDom = document.getElementById('mainChart');
        const myChart = echarts.init(chartDom);

        // 监听日期输入框变化
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const btn7days = document.getElementById('btn-7days');
        const btn30days = document.getElementById('btn-30days');
        
        // 更新按钮选中状态
        function updateButtonState(activeButton) {
            // 重置所有按钮样式
            btn7days.className = 'px-3 py-1.5 text-xs font-medium bg-white hover:bg-slate-50 border border-slate-200 rounded-lg text-slate-600 transition-colors';
            btn30days.className = 'px-3 py-1.5 text-xs font-medium bg-white hover:bg-slate-50 border border-slate-200 rounded-lg text-slate-600 transition-colors';
            
            // 设置选中按钮样式
            if (activeButton === 7) {
                btn7days.className = 'px-3 py-1.5 text-xs font-medium bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg text-blue-600 transition-colors';
            } else if (activeButton === 30) {
                btn30days.className = 'px-3 py-1.5 text-xs font-medium bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg text-blue-600 transition-colors';
            }
        }
        
        startDateInput.addEventListener('change', async () => {
            updateButtonState(null); // 手动选择日期时清除按钮选中状态
            await fetchData(startDateInput.value, endDateInput.value);
            renderPage();
        });
        endDateInput.addEventListener('change', async () => {
            updateButtonState(null); // 手动选择日期时清除按钮选中状态
            await fetchData(startDateInput.value, endDateInput.value);
            renderPage();
        });

        // 格式化本地日期为 YYYY-MM-DD 格式，避免时区问题
        function formatLocalDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function setRange(days) {
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - (days - 1)); // 包含今天

            // 使用本地时间避免时区问题
            endDateInput.value = formatLocalDate(end);
            startDateInput.value = formatLocalDate(start);
            
            // 更新按钮选中状态
            updateButtonState(days);
            
            await fetchData(startDateInput.value, endDateInput.value);
            renderPage();
        }

        function renderPage() {
            const startStr = startDateInput.value;
            const endStr = endDateInput.value;
            
            if (!startStr || !endStr) return;

            // 1. 过滤数据
            const filteredData = fullData.filter(item => {
                return item.created_at >= startStr && item.created_at <= endStr;
            });
            // 2. 更新统计卡片 (计算平均值)
            updateStats(filteredData);

            // 3. 更新图表
            updateChart(filteredData);

            // 4. 更新表格 (只显示最近10条)
            updateTable(filteredData);
        }

        function updateStats(data) {
            if (data.length === 0) {
                ['stat-dl', 'stat-ul', 'stat-ping', 'stat-count'].forEach(id => document.getElementById(id).innerText = '-');
                return;
            }
            
            const avgDl = (data.reduce((sum, item) => sum + item.download, 0) / data.length).toFixed(1);
            const avgUl = (data.reduce((sum, item) => sum + item.upload, 0) / data.length).toFixed(1);
            const avgPing = (data.reduce((sum, item) => sum + item.ping, 0) / data.length).toFixed(0);

            document.getElementById('stat-dl').innerText = avgDl;
            document.getElementById('stat-ul').innerText = avgUl;
            document.getElementById('stat-ping').innerText = avgPing;
            document.getElementById('stat-count').innerText = data.length;
        }

        function updateTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            // 接口已经倒序排列，直接使用
            const displayList = data;
            
            displayList.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors';
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium text-slate-700">${row.created_at}</td>
                    <td class="px-4 py-3 text-slate-500">${row.server_name}</td>
                    <td class="px-4 py-3 text-right font-bold text-blue-600">${row.download}</td>
                    <td class="px-4 py-3 text-right text-slate-600">${row.upload}</td>
                    <td class="px-4 py-3 text-right">
                        <span class="${row.ping > 50 ? 'text-red-500 font-bold' : 'text-emerald-600'}">${row.ping}</span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateChart(data) {
            // 图表需要升序显示（从旧到新），所以反转数据
            const chartData = [...data].reverse();
            
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(255, 255, 255, 0.95)', // 亮色 Tooltip
                    borderColor: '#e2e8f0',
                    textStyle: { color: '#334155' },
                    extraCssText: 'box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px;'
                },
                grid: { left: '1%', right: '2%', top: '10%', bottom: '5%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: chartData.map(i => i.created_at.slice(5)), // 只看 MM-DD
                    axisLine: { show: false },
                    axisTick: { show: false },
                    axisLabel: { color: '#94a3b8' }
                },
                yAxis: {
                    type: 'value',
                    splitLine: { lineStyle: { color: '#f1f5f9' } }, // 极淡的分割线
                    axisLabel: { color: '#94a3b8' }
                },
                series: [
                    {
                        name: '下载',
                        type: 'line',
                        smooth: 0.25,
                        showSymbol: false,
                        data: chartData.map(i => i.download),
                        itemStyle: { color: '#3b82f6' },
                        lineStyle: { width: 3 },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(59, 130, 246, 0.2)' },
                                { offset: 1, color: 'rgba(59, 130, 246, 0)' }
                            ])
                        }
                    },
                    {
                        name: '上传',
                        type: 'line',
                        smooth: 0.25,
                        showSymbol: false,
                        data: chartData.map(i => i.upload),
                        itemStyle: { color: '#a855f7' },
                        lineStyle: { width: 2, type: 'dashed' }
                    }
                ]
            };
            myChart.setOption(option);
        }

        // ==========================================
        // 3. 初始化
        // ==========================================
        (async function init() {
            await setRange(30); // 默认显示最近30天
            window.addEventListener('resize', myChart.resize);
        })();

    </script>
</body>
</html>