<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>华硕路由器历史流量审计系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
    <style>
        :root {
            --ios-bg: #F2F2F7;
            --ios-card: rgba(255, 255, 255, 0.7);
            --ios-blue: #007AFF;
            --ios-green: #34C759;
        }
        body {
            background-color: var(--ios-bg);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            color: #1c1c1e;
        }
        .glass-card {
            background: var(--ios-card);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .active-device {
            border: 2px solid var(--ios-blue) !important;
            background: white !important;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-[1600px] mx-auto">
        <div class="flex justify-between items-end mb-8 px-2">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">流量统计报告</h1>
                <p class="text-sm text-gray-500">所有数据基于历史离线统计</p>
            </div>
            <div class="glass-card px-4 py-2 flex items-center gap-4">
                <span class="text-xs font-bold text-gray-400">查询周期:</span>
                <input id="date-picker" type="text" class="bg-transparent border-none outline-none text-sm text-blue-600 font-semibold w-48" placeholder="选择范围">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-card p-6">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">累计上行流量 (Total TX)</div>
                <div class="text-3xl font-bold text-green-600" id="kpi-total-up">-- <span class="text-sm font-normal text-gray-400 uppercase">GB</span></div>
            </div>
            <div class="glass-card p-6">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">累计下行流量 (Total RX)</div>
                <div class="text-3xl font-bold text-blue-600" id="kpi-total-down">-- <span class="text-sm font-normal text-gray-400 uppercase">TB</span></div>
            </div>
            <div class="glass-card p-6">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">日均上传 (Avg TX)</div>
                <div class="text-2xl font-bold" id="kpi-avg-up">-- <span class="text-sm font-normal text-gray-400">GB/Day</span></div>
            </div>
            <div class="glass-card p-6">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">日均下载 (Avg RX)</div>
                <div class="text-2xl font-bold" id="kpi-avg-down">-- <span class="text-sm font-normal text-gray-400">GB/Day</span></div>
            </div>
        </div>

        <div class="grid grid-cols-12 gap-8">
            
            <div class="col-span-3 space-y-4">
                <h3 class="text-xs font-bold text-gray-400 uppercase px-2">设备列表</h3>
                <div class="h-[888px] overflow-y-auto no-scrollbar space-y-3" id="device-list">
                    </div>
            </div>

            <div class="col-span-9 space-y-8">
                <div class="glass-card p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold" id="chart-title">所有设备：每日流量趋势</h2>
                        <div class="flex gap-4">
                            <span class="text-xs flex items-center gap-1"><i class="w-3 h-3 bg-blue-500 rounded-full"></i> 下行</span>
                            <span class="text-xs flex items-center gap-1"><i class="w-3 h-3 bg-green-500 rounded-full"></i> 上行</span>
                        </div>
                    </div>
                    <div id="main-trend-chart" class="w-full h-[400px]"></div>
                </div>

                <div class="glass-card p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-bold">设备流量排行榜</h2>
                        <div class="flex gap-2">
                            <button onclick="switchRankType('download')" id="btn-rank-download" class="px-3 py-1 text-xs rounded-lg bg-blue-500 text-white">下行排名</button>
                            <button onclick="switchRankType('upload')" id="btn-rank-upload" class="px-3 py-1 text-xs rounded-lg bg-gray-200 text-gray-600">上行排名</button>
                            <button onclick="switchRankType('total')" id="btn-rank-total" class="px-3 py-1 text-xs rounded-lg bg-gray-200 text-gray-600">总流量排名</button>
                        </div>
                    </div>
                    <div id="device-rank-chart" class="w-full h-[320px]"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局数据存储
        let fullData = null;
        let currentDeviceId = 'all';
        let currentDeviceName = '所有设备';
        let dateRange = { start: null, end: null };
        let currentRankType = 'download'; // 当前排行榜类型

        // 初始化日期选择（中文、默认15天）
        const datePicker = flatpickr("#date-picker", {
            mode: "range",
            locale: "zh",
            defaultDate: [new Date(Date.now() - 14 * 24 * 60 * 60 * 1000), new Date()],
            dateFormat: "Y-m-d",
            onClose: function(selectedDates) {
                if (selectedDates.length === 2) {
                    dateRange.start = selectedDates[0].toISOString().split('T')[0];
                    dateRange.end = selectedDates[1].toISOString().split('T')[0];
                    console.log("日期更新：", dateRange);
                    fetchData();
                }
            }
        });

        // 设置默认日期范围（15天前至当前）
        const now = new Date();
        const startDate = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);
        dateRange.start = startDate.toISOString().split('T')[0];
        dateRange.end = now.toISOString().split('T')[0];

        // 从API获取数据
        async function fetchData() {
            try {
                
                const response = await fetch(`/api/AsusRouter/GetTrafficMonitoringData?startDate=${dateRange.start}&endDate=${dateRange.end}`);
                const result = await response.json();
                
                if (result.success) {
                    fullData = result.data;
                    renderPage();
                    console.log('数据已更新:', {
                        日期范围: `${dateRange.start} ~ ${dateRange.end}`,
                        设备数: fullData.devices.length,
                        KPI: fullData.kpi
                    });
                } else {
                    console.error('获取数据失败:', result.message);
                    alert('获取数据失败: ' + result.message);
                }
            } catch (error) {
                console.error('请求失败:', error);
                alert('请求失败: ' + error.message);
            }
        }

        // 渲染整个页面
        function renderPage() {
            if (!fullData) return;

            // 1. 渲染KPI统计
            document.getElementById('kpi-total-up').innerHTML = 
                `${fullData.kpi.totalUploadFormatted.replace(/([0-9.]+)([A-Z]+)/, '$1 <span class="text-sm font-normal text-gray-400 uppercase">$2</span>')}`;
            document.getElementById('kpi-total-down').innerHTML = 
                `${fullData.kpi.totalDownloadFormatted.replace(/([0-9.]+)([A-Z]+)/, '$1 <span class="text-sm font-normal text-gray-400 uppercase">$2</span>')}`;
            
            document.getElementById('kpi-avg-up').innerHTML = 
                `${fullData.kpi.avgDailyUpload.replace(/([0-9.]+)([A-Z]+)/, '$1 <span class="text-sm font-normal text-gray-400">$2/Day</span>')}`;
            document.getElementById('kpi-avg-down').innerHTML = 
                `${fullData.kpi.avgDailyDownload.replace(/([0-9.]+)([A-Z]+)/, '$1 <span class="text-sm font-normal text-gray-400">$2/Day</span>')}`;

            // 2. 渲染设备列表
            renderDeviceList();

            // 3. 渲染趋势图表
            updateTrendChart(fullData.dailyTrends);

            // 4. 渲染设备排行榜
            updateDeviceRankChart(fullData.devices, currentRankType);
        }

        // 渲染设备列表
        function renderDeviceList() {
            if (!fullData || !fullData.devices) return;

            const deviceContainer = document.getElementById('device-list');
            deviceContainer.innerHTML = fullData.devices.map(d => `
                <div class="glass-card p-4 flex items-center justify-between cursor-pointer hover:bg-white transition-all border-2 border-transparent ${d.id === currentDeviceId ? 'active-device' : ''}" 
                     onclick="switchDevice('${d.id}', '${d.name.replace(/'/g, "\\'")}')"
                     id="card-${d.id}">
                    <div class="flex items-center gap-4">
                        <div class="text-2xl">${d.icon}</div>
                        <div>
                            <div class="text-sm font-bold">${d.name}</div>
                            <div class="text-[10px] text-gray-400">选定周期累计流量</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-green-600 font-mono">↑ ${d.upFormatted}</div>
                        <div class="text-[10px] text-blue-600 font-mono">↓ ${d.downFormatted}</div>
                    </div>
                </div>
            `).join('');
        }

        // 初始化 ECharts
        let trendChart = echarts.init(document.getElementById('main-trend-chart'));
        let deviceRankChart = echarts.init(document.getElementById('device-rank-chart'));

        // 切换设备逻辑
        window.switchDevice = async (id, name) => {
            currentDeviceId = id;
            currentDeviceName = name;

            // 更新 UI 状态
            document.querySelectorAll('#device-list > div').forEach(el => el.classList.remove('active-device'));
            const cardElement = document.getElementById('card-' + id);
            if (cardElement) {
                cardElement.classList.add('active-device');
            }
            document.getElementById('chart-title').innerText = `${name}：每日流量趋势`;

            // 如果选择"所有设备"，使用已有的fullData
            if (id === 'all') {
                if (fullData && fullData.dailyTrends) {
                    updateTrendChart(fullData.dailyTrends);
                }
            } else {
                // 获取单个设备的流量趋势
                try {
                    const response = await fetch(`/api/AsusRouter/GetDeviceDailyTraffic?mac=${id}&startDate=${dateRange.start}&endDate=${dateRange.end}`);
                    const result = await response.json();
                    
                    if (result.success && result.data.dailyTrends) {
                        updateTrendChart(result.data.dailyTrends);
                    } else {
                        console.error('获取设备流量失败:', result.message);
                        // 如果失败，显示空数据
                        updateTrendChart([]);
                    }
                } catch (error) {
                    console.error('请求设备流量失败:', error);
                    updateTrendChart([]);
                }
            }
        };

        // 更新趋势图表
        const updateTrendChart = (dailyTrends) => {
            if (!dailyTrends || dailyTrends.length === 0) {
                trendChart.setOption({
                    title: { text: '暂无数据', left: 'center', top: 'center', textStyle: { color: '#999' } }
                });
                return;
            }

            const dates = dailyTrends.map(d => d.date);
            const downData = dailyTrends.map(d => d.downloadGB);
            const upData = dailyTrends.map(d => d.uploadGB);

            trendChart.setOption({
                tooltip: { 
                    trigger: 'axis',
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(item => {
                            result += item.marker + item.seriesName + ': ' + item.value + ' GB<br/>';
                        });
                        return result;
                    }
                },
                grid: { left: '3%', right: '3%', bottom: '3%', top: '5%', containLabel: true },
                xAxis: { 
                    type: 'category', 
                    data: dates, 
                    axisTick: {show: false}, 
                    axisLine: {lineStyle: {color: '#ddd'}},
                    axisLabel: { rotate: 45 }
                },
                yAxis: { 
                    type: 'value', 
                    name: 'GB',
                    splitLine: {lineStyle: {color: '#eee'}} 
                },
                series: [
                    {
                        name: '下行流量', 
                        type: 'line', 
                        smooth: true, 
                        symbol: 'circle',
                        symbolSize: 6,
                        lineStyle: { color: '#007AFF', width: 3 },
                        areaStyle: { 
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0, color: 'rgba(0,122,255,0.3)'}, 
                                {offset: 1, color: 'rgba(0,122,255,0.05)'}
                            ]) 
                        },
                        data: downData
                    },
                    {
                        name: '上行流量', 
                        type: 'line', 
                        smooth: true, 
                        symbol: 'circle',
                        symbolSize: 6,
                        lineStyle: { color: '#34C759', width: 2 },
                        areaStyle: { 
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                {offset: 0, color: 'rgba(52,199,89,0.2)'}, 
                                {offset: 1, color: 'rgba(52,199,89,0.05)'}
                            ]) 
                        },
                        data: upData
                    }
                ]
            });
        };

        // 更新设备排行榜
        const updateDeviceRankChart = (devices, rankType) => {
            if (!devices || devices.length <= 1) { // 至少需要2个设备（包括“所有设备”）
                deviceRankChart.setOption({
                    title: { text: '暂无设备数据', left: 'center', top: 'center', textStyle: { color: '#999' } }
                });
                return;
            }

            // 过滤掉“所有设备”，只显示具体设备
            const realDevices = devices.filter(d => d.id !== 'all');
            
            // 根据排行类型排序
            let sortedDevices = [...realDevices];
            if (rankType === 'download') {
                sortedDevices.sort((a, b) => b.downloadBytes - a.downloadBytes);
            } else if (rankType === 'upload') {
                sortedDevices.sort((a, b) => b.uploadBytes - a.uploadBytes);
            } else { // total
                sortedDevices.sort((a, b) => (b.downloadBytes + b.uploadBytes) - (a.downloadBytes + a.uploadBytes));
            }

            // 只取前10个设备
            const topDevices = sortedDevices.slice(0, 10);
            
            const deviceNames = topDevices.map(d => d.name);
            const deviceData = topDevices.map(d => {
                if (rankType === 'download') {
                    return (d.downloadBytes / 1073741824).toFixed(2);
                } else if (rankType === 'upload') {
                    return (d.uploadBytes / 1073741824).toFixed(2);
                } else {
                    return ((d.downloadBytes + d.uploadBytes) / 1073741824).toFixed(2);
                }
            });

            // 颜色渐变：第一名最深，依次变浅
            const colors = topDevices.map((_, index) => {
                const ratio = 1 - (index / topDevices.length) * 0.6; // 0.4-1.0
                if (rankType === 'download') {
                    return `rgba(37, 99, 235, ${ratio})`; // 蓝色
                } else if (rankType === 'upload') {
                    return `rgba(34, 197, 94, ${ratio})`; // 绿色
                } else {
                    return `rgba(168, 85, 247, ${ratio})`; // 紫色
                }
            });

            deviceRankChart.setOption({
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: function(params) {
                        return `${params[0].name}<br/>${params[0].marker}流量: ${params[0].value} GB`;
                    }
                },
                grid: { 
                    left: '3%', 
                    right: '4%', 
                    bottom: '3%', 
                    top: '5%', 
                    containLabel: true 
                },
                xAxis: {
                    type: 'value',
                    name: 'GB',
                    splitLine: { show: true, lineStyle: { color: '#f0f0f0' } }
                },
                yAxis: {
                    type: 'category',
                    data: deviceNames.reverse(), // 反转使第一名在最上方
                    axisTick: { show: false },
                    axisLine: { show: false },
                    axisLabel: {
                        fontSize: 11,
                        width: 120,
                        overflow: 'truncate'
                    }
                },
                series: [
                    {
                        type: 'bar',
                        data: deviceData.reverse().map((value, index) => ({
                            value,
                            itemStyle: { 
                                color: colors.reverse()[index],
                                borderRadius: [0, 6, 6, 0]
                            }
                        })),
                        barWidth: '60%',
                        label: {
                            show: true,
                            position: 'right',
                            formatter: '{c} GB',
                            fontSize: 11,
                            color: '#666'
                        },
                        emphasis: {
                            itemStyle: {
                                shadowBlur: 10,
                                shadowColor: 'rgba(0,0,0,0.3)'
                            }
                        }
                    }
                ]
            });
        };

        // 切换排行榜类型
        window.switchRankType = (type) => {
            currentRankType = type;
            
            // 更新按钮样式
            document.getElementById('btn-rank-download').className = 
                type === 'download' ? 'px-3 py-1 text-xs rounded-lg bg-blue-500 text-white' : 'px-3 py-1 text-xs rounded-lg bg-gray-200 text-gray-600';
            document.getElementById('btn-rank-upload').className = 
                type === 'upload' ? 'px-3 py-1 text-xs rounded-lg bg-green-500 text-white' : 'px-3 py-1 text-xs rounded-lg bg-gray-200 text-gray-600';
            document.getElementById('btn-rank-total').className = 
                type === 'total' ? 'px-3 py-1 text-xs rounded-lg bg-purple-500 text-white' : 'px-3 py-1 text-xs rounded-lg bg-gray-200 text-gray-600';
            
            // 重新渲染图表
            if (fullData && fullData.devices) {
                updateDeviceRankChart(fullData.devices, type);
            }
        };

        // 页面加载时获取数据
        window.onload = () => {
            fetchData();
        };

        // 窗口大小改变时重绘图表
        window.addEventListener('resize', () => {
            trendChart.resize();
            deviceRankChart.resize();
        });
    </script>
</body>
</html>